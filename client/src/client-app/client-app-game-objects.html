<link rel="import" href="../libs/phaser-js.html">

<script>
  class Boat extends Phaser.GameObjects.Sprite {
    constructor( scene, name) {
      console.info( `Boat: constructor( scene, '${name}') called`);
      super( scene, null, null, 'boat', 0);

      // Identifier of the boat, used to lookup its state in the datastore
      this.name = "" + name;

      // Properties that are synced from the datastore state
      this.data = null;
      this.direction = null;
      this.windDirection = null;

      // Rescales the boat from 600 pixels to 100
      this.setScale( 0.1667, 0.1667);

      // Add an event listener, to change tint on click
      let boat = this;
      this.setInteractive();
      this.on( 'pointerdown', function boatClicked() {
        boat.setAlpha( 0.25 + Math.random() * 0.75); });

      // Trigger initial synchronization of the Boat sprite state
      // with the boat entity of the datastore it is bound to
      this.update();
    }

    fetchData() {
      // Fetch the state of the boat from the datastore, looking up
      // the boat entities for the one matching the boat id
      const store = this.scene.data.get( 'store');
      const state = store.getState();
      const dataStorePath = [ 'boats', this.name ];
      const data = state.getIn( dataStorePath);

      if (data === undefined) {
        throw new Error( `Boat.constructor(): cannot bind to datastore; it is expected to contain a boat with given name '${name}'`);
      }

      // Data chunk describing the state of the boat (latest state)
      this.data = data;

      // Direction the boat is heading towards, expressed as an angle,
      // in degrees: 0 = N, 45 = NE, 90 = E, 180 = S, 270 = W
      this.direction = data.direction;

      // Incoming direction of the wind, relative to the boat, expressed
      // as an angle, in degrees: 0 = wind comes from N (front),
      // 90 = wind comes from E (tribord), 180 = wind come from
      // south (behind), 270 = wind comes from W (babord)
      this.windDirection = data.windDirection;
    }

    update() {
      console.info( "Boat: update() called");

      // Fetch the state with the datastore
      this.fetchData();

      // Re-position the boat in scene coordinates
      let targetX = 50.0 * this.data.position.col;
      let targetY = 50.0 * this.data.position.row;
      if ((this.x == null) ||( this.y == null)) {
        // Reposition the sprite, if it was not set earlier
        this.x = targetX;
        this.y = targetY;
      } else {
        // TODO: Move it to the new position with a tween animation
        this.x = targetX;
        this.y = targetY;
      }

      // Select correct sprite frame, depending on current
      // boat direction and incoming wind direction
      //
      // FIXME: correct the algorithm with the number of frames
      // we currently have
      let _boatDirQuadrant = 0;
      let _calcSailType = 0;
      let _sailType = 0;

      if (this.direction >= 315 || this.direction < 45) {
        //facing up
        _boatDirQuadrant = 0;
      } else if (this.direction >= 45 && this.direction < 135) {
        //facing right
        _boatDirQuadrant = 1;
      } else if (this.direction >= 135 &&  this.direction < 225) {
        //facing down
        _boatDirQuadrant = 2;
      } else if (this.direction >=  225 && this.direction < 315) {
        //facing left
        _boatDirQuadrant = 3;
      }

      if (this.windDirection >= 315 || this.windDirection < 45) {
        //If wind Direction is either north
        _calcSailType = _boatDirQuadrant;
      } else if (this.windDirection >=  45 && this.windDirection < 135) {
        //If the wind direction is East
        _calcSailType += 1;
      } else if (this.windDirection >= 135 && this.windDirection < 225) {
        //South
        _calcSailType += 2;
      } else if (this.windDirection >=  225 && this.windDirection < 315) {
        //If the wind direction is west
        _calcSailType += + 3;
      }

      if (_calcSailType > 2) { 
        _calcSailType -= - 2;
      }

      // FIXME: does not work
      // this.frame = ([ 1, 2, 1])[ _calcSailType];
      this.angle = this.direction;
    }
  }
</script>